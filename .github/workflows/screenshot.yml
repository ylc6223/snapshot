# Screenshot Service æ‰¹é‡æˆªå›¾å·¥ä½œæµ
# 
# è§¦å‘æ–¹å¼:
# 1. å®šæ—¶è§¦å‘: æ¯å¤© UTC 00:00 (åŒ—äº¬æ—¶é—´ 08:00)
# 2. æ‰‹åŠ¨è§¦å‘: GitHub Actions é¡µé¢ç‚¹å‡» "Run workflow"
# 3. API è§¦å‘: POST /repos/{owner}/{repo}/dispatches

name: Screenshot Batch

on:
  # å®šæ—¶è§¦å‘ - æ¯å¤© UTC 00:00 (åŒ—äº¬æ—¶é—´ 08:00)
  schedule:
    - cron: '0 0 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      limit:
        description: 'æœ€å¤§å¤„ç†æ•°é‡ (ç•™ç©ºåˆ™å¤„ç†å…¨éƒ¨)'
        required: false
        default: ''
  
  # API è§¦å‘ (ä¾› Next.js è°ƒç”¨)
  repository_dispatch:
    types: [screenshot_request]

jobs:
  screenshot:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 å°æ—¶è¶…æ—¶

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ­ å®‰è£… Playwright æµè§ˆå™¨
        run: npx playwright install chromium --with-deps

      - name: ğŸ“¸ æ‰§è¡Œæˆªå›¾ä»»åŠ¡
        env:
          # R2 é…ç½®
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
          # API é…ç½®
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          DATABASE_API_KEY: ${{ secrets.DATABASE_API_KEY }}
          # åŠ¨æ€å‚æ•° (ç”¨äºç²¾å‡†æ¨¡å¼)
          RESOURCE_IDS: ${{ github.event.client_payload.resourceIds }}
        run: npm start

      - name: ğŸ“Š ä»»åŠ¡å®Œæˆ
        if: always()
        run: echo "æˆªå›¾ä»»åŠ¡å·²å®Œæˆï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—äº†è§£è¯¦æƒ…"
